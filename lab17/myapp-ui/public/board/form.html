<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>게시글 작성</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input[type="text"], textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        textarea {
            resize: vertical;
        }
        
        .error {
            color: red;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .saving {
            text-align: center;
            color: #666;
            margin: 20px 0;
        }
        
        .buttons {
            margin: 20px 0;
        }
        
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        a {
            color: #007bff;
            text-decoration: none;
        }
        
        a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;
        
        // 컴포넌트 외부에 정의된 순수 함수들
        const validateFormData = (formData) => {
            const newErrors = {};
            
            // 제목 검사
            const title = formData.title.trim();
            if (!title) {
                newErrors.title = '제목을 입력해주세요.';
            } else if (title.length < 2 || title.length > 100) {
                newErrors.title = '제목은 2자 이상 100자 이내로 입력해주세요.';
            }
            
            // 내용 검사
            const content = formData.content.trim();
            if (!content) {
                newErrors.content = '내용을 입력해주세요.';
            } else if (content.length < 10 || content.length > 5000) {
                newErrors.content = '내용은 10자 이상 5000자 이내로 입력해주세요.';
            }
            
            return newErrors;
        };
        
        const saveBoardData = async (formData) => {
            const response = await axios.post('http://localhost:9999/boards', {
                title: formData.title,
                content: formData.content
            }, {
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const jsonResult = response.data;
            
            if (jsonResult.status !== 'success') {
                throw new Error(jsonResult.content || '요청 처리 오류');
            }
            
            return jsonResult;
        };
        
        // BoardForm 컴포넌트
        const BoardForm = () => {
            const [formData, setFormData] = useState({
                title: '',
                content: ''
            });
            const [errors, setErrors] = useState({});
            const [saving, setSaving] = useState(false);
            
            // 입력값 변경 핸들러
            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: value
                }));
                
                // 에러 메시지 초기화
                setErrors(prev => {
                    if (prev[name]) {
                        return {
                            ...prev,
                            [name]: ''
                        };
                    }
                    return prev;
                });
            };
            
            // 폼 유효성 검사 - 외부 함수 사용
            const validateForm = () => {
                const newErrors = validateFormData(formData);
                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };
            
            // 게시글 저장 - 외부 함수 사용
            const saveBoard = async () => {
                try {
                    setSaving(true);
                    
                    await saveBoardData(formData);
                    
                    // 0.1초 후 목록 페이지로 이동
                    setTimeout(() => {
                        window.location.href = '/board';
                    }, 100);
                    
                } catch (error) {
                    console.error('게시글 저장 오류:', error);
                    
                    let errorMessage = '서버 응답 오류!';
                    if (error.response && error.response.data && error.response.data.content) {
                        errorMessage = error.response.data.content;
                    }
                    
                    alert(errorMessage);
                } finally {
                    setSaving(false);
                }
            };
            
            // 폼 제출 핸들러
            const handleSubmit = (e) => {
                e.preventDefault();
                
                if (validateForm()) {
                    saveBoard();
                }
            };
            
            return (
                <div className="container">
                    <h1>게시글 작성</h1>
                    
                    <form onSubmit={handleSubmit}>
                        <div className="form-group">
                            <label htmlFor="title">제목 *</label>
                            <input 
                                type="text" 
                                id="title" 
                                name="title" 
                                value={formData.title}
                                onChange={handleInputChange}
                                placeholder="게시글 제목을 입력하세요"
                                required 
                            />
                            {errors.title && <div className="error">{errors.title}</div>}
                        </div>

                        <div className="form-group">
                            <label htmlFor="content">내용 *</label>
                            <textarea 
                                id="content" 
                                name="content" 
                                rows="8" 
                                value={formData.content}
                                onChange={handleInputChange}
                                placeholder="게시글 내용을 입력하세요"
                                required
                            />
                            {errors.content && <div className="error">{errors.content}</div>}
                        </div>

                        {saving && (
                            <div className="saving">
                                게시글을 저장하는 중...
                            </div>
                        )}

                        <div className="buttons">
                            <button type="submit" disabled={saving}>
                                저장
                            </button>
                            <a href="/board">목록으로</a>
                        </div>
                    </form>
                </div>
            );
        };

        // App 컴포넌트 렌더링
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<BoardForm />);

    </script>
</body>
</html>